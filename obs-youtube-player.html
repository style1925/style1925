<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>YT Play-Support Tool</title>
  <style>
    /* OBS最適化：スクロールバー排除 */
    ::-webkit-scrollbar { display: none; }

    html, body {
      margin: 0; padding: 0; width: 100%; height: 100%;
      overflow: hidden; background: transparent;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }

    /* 再生用プレイヤー：再生開始時にフェードイン */
    iframe {
      border: 0; width: 100%; height: 100%;
      display: none; background: #000;
      animation: fadeIn 0.4s ease-out;
    }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* 操作ドックUI */
    #form {
      position: absolute; top: 50%; left: 50%;
      transform: translate(-50%, -50%); z-index: 10;
      background: rgba(30, 30, 30, 0.98); padding: 25px;
      border-radius: 16px; color: #fff; text-align: center;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
      width: 90%; max-width: 450px; display: none;
      border: 1px solid #444;
    }

    h2 { font-size: 1.2rem; margin-bottom: 20px; font-weight: 800; color: #00ff7f; letter-spacing: 0.05em; }
    
    input {
      width: 100%; padding: 12px; font-size: 1rem;
      border: 2px solid #555; border-radius: 8px;
      margin-bottom: 15px; box-sizing: border-box;
      outline: none; background: #000; color: #fff;
    }
    input:focus { border-color: #00ff7f; }

    .btn-group { display: flex; gap: 10px; }

    button {
      flex: 2; padding: 12px; font-size: 1rem; background: #00ff7f;
      color: #000; border: none; border-radius: 8px;
      cursor: pointer; font-weight: 800; transition: all 0.2s;
    }

    button.stop { flex: 1; background: #555; color: #fff; }
    button:hover { opacity: 0.8; transform: translateY(-1px); }
    button:active { transform: translateY(0); opacity: 0.6; }

    #status { margin-top: 15px; min-height: 1.2em; font-size: 0.85rem; font-weight: bold; }
    .msg-error { color: #ff5555; }
    .msg-success { color: #00ff7f; }

    /* セットアップ案内 */
    #setup-guide {
      color: #ccc; background: #0f0f0f; padding: 40px;
      height: 100%; box-sizing: border-box; overflow: auto; display: none;
    }
    .url-display {
      background: #1a1a1a; padding: 12px; border-radius: 6px;
      margin: 8px 0 25px; word-break: break-all;
      font-family: 'Consolas', monospace; border: 1px solid #333; color: #00ff7f;
    }
    strong { color: #fff; display: block; margin-bottom: 5px; font-size: 1rem; }
  </style>
</head>
<body>

<!-- 操作用ドック画面 -->
<div id="form">
  <h2>YT PLAY-SUPPORT</h2>
  <input type="text" id="url" placeholder="YouTube URLを入力..." spellcheck="false" autocomplete="off" />
  <div class="btn-group">
    <button id="playBtn">PLAY</button>
    <button id="stopBtn" class="stop">STOP</button>
  </div>
  <div id="status"></div>
</div>

<!-- 再生画面用プレイヤー -->
<iframe id="player" allow="autoplay; encrypted-media; fullscreen; picture-in-picture" allowfullscreen></iframe>

<!-- モード未指定時のガイド -->
<div id="setup-guide">
  <h2 style="color:#00ff7f">SETUP GUIDE</h2>
  <p>各URLをコピーしてOBSに登録してください：</p>
  <strong>1. カスタムブラウザドック (操作用)</strong>
  <div class="url-display" id="url-dock"></div>
  <strong>2. ブラウザソース (再生用)</strong>
  <div class="url-display" id="url-player"></div>
</div>

<script>
  const iframe = document.getElementById('player');
  const form = document.getElementById('form');
  const guide = document.getElementById('setup-guide');
  const input = document.getElementById('url');
  const status = document.getElementById('status');
  const playBtn = document.getElementById('playBtn');
  const stopBtn = document.getElementById('stopBtn');

  const urlParams = new URLSearchParams(window.location.search);
  const mode = urlParams.get('mode');
  const baseUrl = window.location.origin + window.location.pathname;

  // YouTube ID抽出：配列の1番目の要素（11桁の文字列）を返します
  function getVideoId(url) {
    const patterns = [
      /youtu\.be\/([a-zA-Z0-9_-]{11})/,
      /youtube\.com\/(?:watch\?v=|embed\/|shorts\/|live\/)([a-zA-Z0-9_-]{11})/
    ];
    for (let p of patterns) {
      const m = url.match(p);
      // インデックス[1]を指定して文字列のみを抽出
      if (m && m[1]) return m[1];
    }
    return null;
  }

  // プレイヤーの再生・停止制御
  function setPlayerState(id) {
    if (id) {
      const params = "autoplay=1&controls=1&fs=0&iv_load_policy=3&rel=0&playsinline=1&enablejsapi=1";
      iframe.src = `https://www.youtube.com/embed/${id}?${params}`;
      iframe.style.display = 'block';
      document.body.style.background = '#000';
    } else {
      iframe.src = '';
      iframe.style.display = 'none';
      document.body.style.background = 'transparent';
    }
  }

  function showStatus(text, isError = false) {
    status.textContent = text;
    status.className = isError ? 'msg-error' : 'msg-success';
    setTimeout(() => status.textContent = '', 3000);
  }

  // 動作モード判定
  if (mode === 'dock') {
    document.body.style.background = '#1a1a1a';
    form.style.display = 'block';
    
    playBtn.onclick = () => {
      const id = getVideoId(input.value.trim());
      if (id) {
        localStorage.setItem('ps_obs_trigger', JSON.stringify({action: 'play', id: id, time: Date.now()}));
        showStatus('PLAYERへ送信完了');
        input.value = '';
      } else {
        showStatus('無効なURLです', true);
      }
    };

    stopBtn.onclick = () => {
      localStorage.setItem('ps_obs_trigger', JSON.stringify({action: 'stop', time: Date.now()}));
      showStatus('プレイヤーをリセット');
    };

  } else if (mode === 'player') {
    window.addEventListener('storage', (e) => {
      if (e.key === 'ps_obs_trigger' && e.newValue) {
        const data = JSON.parse(e.newValue);
        if (data.action === 'play') setPlayerState(data.id);
        else if (data.action === 'stop') setPlayerState(null);
      }
    });
  } else {
    guide.style.display = 'block';
    document.body.style.background = '#0f0f0f';
    document.getElementById('url-dock').textContent = baseUrl + '?mode=dock';
    document.getElementById('url-player').textContent = baseUrl + '?mode=player';
  }

  input.addEventListener('keypress', e => e.key === 'Enter' && playBtn.onclick());
  if(mode === 'dock') window.onload = () => input.focus();
</script>

</body>
</html>
